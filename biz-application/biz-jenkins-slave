pipeline {
  environment {
    tag = "biz-ms"
    imageName = "usr998/atlant-devops:$tag"
    reg = 'Dockerhub'
    image = ''
  }

  agent { label 'Jenkins_Slave' }


  stages {

    stage("Maven build and test") {
      steps {
        sh "cd ./biz-application && mvn clean install"
      }
    }

    stage("Build biz-ms image") {
      steps {
        script {
          image = docker.build(imageName, "./biz-application")
        }
      }
    }

    stage("Push image to Dockerhub") {
      steps {
        script {
          docker.withRegistry('', reg) {
            image.push('$tag')
          }
        }
      }
    }
  }

  post {
    always {
      sh "yes | docker image prune"
       cleanWs()
    }
  }
}
